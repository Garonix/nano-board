# Nano Board 架构设计

## 概述

Nano Board 是一个基于 Next.js 的现代化白板应用，采用模块化架构设计，支持文本编辑、图片处理和用户认证等功能。

## 技术架构

### 前端架构

```
┌─────────────────────────────────────────┐
│                 UI Layer                │
├─────────────────────────────────────────┤
│  Components (React + TypeScript)       │
│  ├── Board (白板画布)                   │
│  ├── TextBlock (文本块)                 │
│  ├── ImageBlock (图片块)                │
│  └── Toolbar (工具栏)                   │
├─────────────────────────────────────────┤
│           State Management              │
│  ├── boardStore (白板状态)              │
│  └── settingsStore (应用设置)           │
├─────────────────────────────────────────┤
│              Utils & Libs               │
│  ├── logger (日志系统)                  │
│  ├── utils (工具函数)                   │
│  └── types (类型定义)                   │
└─────────────────────────────────────────┘
```

### 后端架构

```
┌─────────────────────────────────────────┐
│              API Routes                 │
│  ├── /api/auth (认证相关)               │
│  ├── /api/boards (白板数据)             │
│  └── /api/settings (应用设置)           │
├─────────────────────────────────────────┤
│            Business Logic               │
│  ├── 用户认证逻辑                       │
│  ├── 白板数据处理                       │
│  └── 文件上传处理                       │
├─────────────────────────────────────────┤
│             Data Layer                  │
│  ├── Prisma ORM                        │
│  └── SQLite Database                   │
└─────────────────────────────────────────┘
```

## 核心模块

### 1. 状态管理 (Zustand)

#### boardStore
- **职责**：管理白板的全局状态
- **主要状态**：
  - `elements`: 白板元素列表
  - `selectedElementId`: 当前选中的元素ID
  - `isLoading`: 加载状态
  - `error`: 错误信息

- **主要操作**：
  - `addTextBlock()`: 添加文本块
  - `addImageBlock()`: 添加图片块
  - `updateElement()`: 更新元素
  - `deleteElement()`: 删除元素
  - `moveElement()`: 移动元素

#### settingsStore
- **职责**：管理应用设置
- **主要设置**：
  - `authEnabled`: 认证开关
  - `maxImageSize`: 图片大小限制
  - `allowedImageTypes`: 允许的图片类型
  - `defaultFontSize`: 默认字体大小

### 2. 组件设计

#### Board (白板画布)
- **功能**：主要的白板界面
- **特性**：
  - 支持拖放操作
  - 处理双击添加文本
  - 处理图片粘贴
  - 网格背景显示

#### TextBlock (文本块)
- **功能**：可编辑的文本组件
- **特性**：
  - 支持纯文本和Markdown模式
  - 拖拽移动和大小调整
  - 实时编辑和保存

#### ImageBlock (图片块)
- **功能**：图片显示组件
- **特性**：
  - 图片加载和错误处理
  - 大小调整和重置
  - 拖拽移动

### 3. 数据流

```
用户操作 → 组件事件 → Store Action → 状态更新 → 组件重渲染
```

#### 示例：添加文本块
1. 用户双击白板空白区域
2. Board组件触发`handleDoubleClick`事件
3. 调用`boardStore.addTextBlock(position)`
4. Store创建新的TextBlock对象并更新状态
5. 组件重新渲染显示新的文本块

### 4. 拖拽系统 (react-dnd)

#### 拖拽类型
- `text-block`: 文本块拖拽
- `image-block`: 图片块拖拽

#### 拖拽流程
1. 组件使用`useDrag`钩子注册为可拖拽
2. Board组件使用`useDrop`钩子接收拖拽
3. 拖拽结束时更新元素位置

### 5. 文件处理

#### 图片上传流程
1. 用户拖放或选择图片文件
2. 验证文件类型和大小
3. 创建本地URL (URL.createObjectURL)
4. 获取图片尺寸信息
5. 创建ImageBlock并添加到白板

#### 支持的操作
- 拖放文件到白板
- 点击按钮选择文件
- 粘贴剪贴板图片

## 数据模型

### 核心实体

#### TextBlock
```typescript
interface TextBlock {
  id: string;
  content: string;
  position: Position;
  size: Size;
  isEditing: boolean;
  isMarkdown: boolean;
  fontSize: number;
  fontColor: string;
  backgroundColor: string;
  createdAt: Date;
  updatedAt: Date;
}
```

#### ImageBlock
```typescript
interface ImageBlock {
  id: string;
  src: string;
  alt: string;
  position: Position;
  size: Size;
  originalSize: Size;
  createdAt: Date;
  updatedAt: Date;
}
```

#### Board
```typescript
interface Board {
  id: string;
  title: string;
  description?: string;
  userId: string;
  elements: BoardElement[];
  isPublic: boolean;
  createdAt: Date;
  updatedAt: Date;
}
```

## 性能优化

### 1. 组件优化
- 使用React.memo避免不必要的重渲染
- 合理使用useCallback和useMemo
- 虚拟化长列表（如果需要）

### 2. 状态优化
- Zustand的选择性订阅
- 避免深层嵌套状态
- 使用immer进行不可变更新

### 3. 图片优化
- 图片懒加载
- 压缩和格式转换
- CDN缓存（生产环境）

### 4. 网络优化
- API请求缓存
- 防抖和节流
- 批量操作

## 安全考虑

### 1. 文件上传安全
- 文件类型验证
- 文件大小限制
- 恶意文件检测

### 2. 用户认证
- JWT令牌验证
- 会话管理
- CSRF保护

### 3. 数据验证
- 输入参数验证
- SQL注入防护
- XSS攻击防护

## 扩展性设计

### 1. 插件系统
- 预留插件接口
- 事件系统
- 自定义组件支持

### 2. 多租户支持
- 数据隔离
- 权限管理
- 资源配额

### 3. 实时协作
- WebSocket连接
- 操作同步
- 冲突解决

## 部署架构

### 开发环境
```
Developer → Next.js Dev Server → SQLite
```

### 生产环境
```
User → Nginx → Next.js App → PostgreSQL/MySQL
     ↓
   CDN (静态资源)
```

### Docker部署
```
Docker Container:
├── Next.js Application
├── SQLite Database
└── File Storage Volume
```

## 监控和日志

### 日志系统
- Winston日志框架
- 分级日志记录
- 结构化日志格式

### 监控指标
- 应用性能监控
- 错误率统计
- 用户行为分析

### 健康检查
- API健康状态
- 数据库连接状态
- 文件系统状态
