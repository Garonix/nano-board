# Nano Board 部署指南

本文档详细介绍了如何在不同环境中部署 Nano Board 应用。

## 🐳 Docker 部署（推荐）

### 快速开始

1. **克隆项目**
```bash
git clone <repository-url>
cd nano-board
```

2. **使用 Docker Compose 启动**
```bash
# 启动应用
docker-compose up -d

# 查看日志
docker-compose logs -f nano-board

# 停止应用
docker-compose down
```

3. **访问应用**
打开浏览器访问 `http://localhost:3000`

### 自定义配置

#### 环境变量配置

在 `docker-compose.yml` 中修改环境变量：

```yaml
environment:
  - NODE_ENV=production
  - LOG_LEVEL=info
  - NEXTAUTH_SECRET=your-very-secure-secret-key
  - NEXTAUTH_URL=https://your-domain.com
```

#### 数据持久化

数据会自动保存到 Docker volumes 中：
- `nano-board-data`: 数据库文件
- `nano-board-logs`: 日志文件
- `nano-board-uploads`: 上传的图片文件

#### 使用 Nginx 反向代理

```bash
# 启动包含 Nginx 的完整服务
docker-compose --profile with-nginx up -d
```

### 生产环境配置

#### SSL/HTTPS 配置

1. **准备SSL证书**
```bash
mkdir -p docker/ssl
# 将证书文件放入 docker/ssl/ 目录
# cert.pem - 证书文件
# key.pem - 私钥文件
```

2. **修改 Nginx 配置**
取消注释 `docker/nginx.conf` 中的 HTTPS 服务器配置

3. **更新 docker-compose.yml**
```yaml
environment:
  - NEXTAUTH_URL=https://your-domain.com
```

#### 性能优化

1. **调整资源限制**
```yaml
services:
  nano-board:
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
```

2. **配置日志轮转**
```yaml
services:
  nano-board:
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
```

## 🖥️ 手动部署

### 系统要求

- Node.js 18+ 
- npm 或 yarn
- 至少 512MB RAM
- 1GB 可用磁盘空间

### 部署步骤

1. **安装依赖**
```bash
npm install
```

2. **构建应用**
```bash
npm run build
```

3. **配置环境变量**
```bash
# 创建 .env.local 文件
cat > .env.local << EOF
NODE_ENV=production
NEXTAUTH_SECRET=your-secret-key
NEXTAUTH_URL=http://localhost:3000
DATABASE_URL=file:./data/nano-board.db
LOG_LEVEL=info
EOF
```

4. **创建数据目录**
```bash
mkdir -p data logs public/uploads
```

5. **启动应用**
```bash
npm start
```

### 使用 PM2 管理进程

1. **安装 PM2**
```bash
npm install -g pm2
```

2. **创建 PM2 配置文件**
```javascript
// ecosystem.config.js
module.exports = {
  apps: [{
    name: 'nano-board',
    script: 'npm',
    args: 'start',
    cwd: '/path/to/nano-board',
    env: {
      NODE_ENV: 'production',
      PORT: 3000
    },
    instances: 1,
    exec_mode: 'fork',
    watch: false,
    max_memory_restart: '512M',
    error_file: './logs/pm2-error.log',
    out_file: './logs/pm2-out.log',
    log_file: './logs/pm2-combined.log',
    time: true
  }]
};
```

3. **启动应用**
```bash
pm2 start ecosystem.config.js
pm2 save
pm2 startup
```

## 🔧 配置选项

### 应用配置

| 环境变量 | 默认值 | 说明 |
|---------|--------|------|
| `NODE_ENV` | development | 运行环境 |
| `PORT` | 3000 | 服务端口 |
| `LOG_LEVEL` | info | 日志级别 |
| `DATABASE_URL` | file:./data/nano-board.db | 数据库连接 |
| `NEXTAUTH_SECRET` | - | 认证密钥（必须设置） |
| `NEXTAUTH_URL` | http://localhost:3000 | 应用URL |

### 功能配置

应用内置设置页面可以配置：
- 用户认证开关
- 图片大小限制
- 允许的图片格式
- 默认样式设置

## 🔍 监控和维护

### 健康检查

应用提供健康检查端点：
```bash
curl http://localhost:3000/api/health
```

### 日志管理

日志文件位置：
- 应用日志: `logs/combined.log`
- 错误日志: `logs/error.log`
- Docker日志: `docker-compose logs`

### 数据备份

#### 备份数据库
```bash
# Docker 环境
docker-compose exec nano-board cp /app/data/nano-board.db /app/data/backup-$(date +%Y%m%d).db

# 手动部署
cp data/nano-board.db data/backup-$(date +%Y%m%d).db
```

#### 备份上传文件
```bash
# Docker 环境
docker run --rm -v nano-board-uploads:/data -v $(pwd):/backup alpine tar czf /backup/uploads-backup-$(date +%Y%m%d).tar.gz -C /data .

# 手动部署
tar czf uploads-backup-$(date +%Y%m%d).tar.gz public/uploads/
```

### 更新应用

#### Docker 更新
```bash
# 拉取最新代码
git pull

# 重新构建并启动
docker-compose up -d --build
```

#### 手动更新
```bash
# 拉取最新代码
git pull

# 安装依赖
npm install

# 重新构建
npm run build

# 重启应用
pm2 restart nano-board
```

## 🚨 故障排除

### 常见问题

1. **端口被占用**
```bash
# 查找占用端口的进程
lsof -i :3000
# 或
netstat -tulpn | grep :3000
```

2. **权限问题**
```bash
# 确保数据目录权限正确
chmod -R 755 data logs public/uploads
```

3. **内存不足**
```bash
# 检查内存使用
free -h
# 增加 swap 空间或升级服务器配置
```

4. **数据库锁定**
```bash
# 检查是否有其他进程在使用数据库
lsof data/nano-board.db
```

### 调试模式

启用调试日志：
```bash
LOG_LEVEL=debug npm start
```

### 获取帮助

如果遇到问题，请：
1. 查看应用日志
2. 检查系统资源使用情况
3. 确认配置文件正确性
4. 提交 Issue 到项目仓库
